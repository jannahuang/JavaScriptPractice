<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>TODOLIST</title>
        <style>
            .done {
                background: lightgray;
                color: white;
                text-decoration: line-through;
            }
        </style>
    </head>
    <body>
        <div class='todo-main'>
            <!--todo-form-->
            <div class='todo-form'>
                <input id='id-input-todo' type="text">
                <button id="id-input-add" type="button">ADD</button>
            </div>
            <!--todo-list-->
            <div id="id-div-container">

            </div>
        </div>
<script>

    var log = function() {
        console.log.apply(console, arguments);
    }
    
    var todoList = []

    var saveTodos = function() {
        var s = JSON.stringify(todoList)
        localStorage.todoList = s
    }

    var loadTodos = function() {
        var s = localStorage.todoList
        return JSON.parse(s)
    }

    var initTodos = function() {
        todoList = loadTodos()
        for (var i = 0; i < todoList.length; i++) {
            var todo = todoList[i]
            insertTodo(todo)
        }
    }

    var bindEventAdd = function() {
        var addButton = document.querySelector('#id-input-add')
        addButton.addEventListener('click', function(){
            var inputTodo = document.querySelector('#id-input-todo')
            var task = inputTodo.value
            var todo = {
                'task': task,
                'ct': currentTime()
            }
            todoList.push(todo)
            saveTodos()
            insertTodo(todo)
        })
    }

    var bindEventButton = function() {
        var todoContainer = document.querySelector('#id-div-container')
        todoContainer.addEventListener('click', function(event){
            log('container click', event, event.target)
            var target = event.target
            if(target.classList.contains('todo-done')) {
                log('done')
                var todoDiv = target.parentElement
                toggleClass(todoDiv, 'done')
            } else if (target.classList.contains('todo-delete')) {
                log('delete')
                var todoDiv = target.parentElement
                var index = indexOfElement(target)
                todoDiv.remove()
                todoList.splice(index, 1)
            }
        })
    }

    var insertTodo = function(todo) {
        var todoContainer = document.querySelector('#id-div-container')
        var t = templateTodo(todo)
        todoContainer.insertAdjacentHTML('beforeend', t)
    }

    var templateTodo = function(todo) {
        var t = `
            <div class='todo-cell'>
                <span>${todo.ct}</span>
                <br>
                <span>${todo.task}</span>
                <button class='todo-delete'>delete</button>
                <button class='todo-done'>done</button>
            </div>
        `
        return t
    }

    var toggleClass = function(element, className) {
        if (element.classList.contains(className)) {
            element.classList.remove(className)
        } else {
            element.classList.add(className)
        }
    }

    var indexOfElement = function(element) {
        var parent = element.parentElement
        for (var i = 0; i < parent.children.length; i++) {
            var e = parent.children[i]
            if (e === element) {
                return i
            }
        }
    }

    var currentTime = function() {
        var d = new Date()
        var year = d.getFullYear()
        var month = d.getMonth() + 1
        var date = d.getDate()
        var hours = d.getHours()
        var minutes = d.getMinutes()
        var seconds = d.getSeconds()
        var timeString = `${year}-${month}-${date} ${hours}:${minutes}:${seconds}`
        return timeString
    }

    var bindEvents =function () {
        bindEventAdd()
        bindEventButton()
    }

    var __main = function () {
        bindEvents()
        initTodos()
    }

    __main()
</script>
    </body>
</html>
